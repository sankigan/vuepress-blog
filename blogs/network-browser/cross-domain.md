---
title: è·¨åŸŸ
date: 2019-3-22
editLink: false
tags:
 - ç½‘ç»œä¸æµè§ˆå™¨
categories:
 - å‰ç«¯
---

# è·¨åŸŸ

## è·¨åŸŸæ¦‚è¿°

å½“ä¸€ä¸ªèµ„æºä»ä¸è¯¥èµ„æºæœ¬èº«æ‰€åœ¨çš„æœåŠ¡å™¨ä¸åŒçš„ **`åŸŸã€åè®®ã€ç«¯å£`** è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œèµ„æºä¼šå‘èµ·ä¸€ä¸ªè·¨åŸŸ HTTP è¯·æ±‚ã€‚å‡ºäºå®‰å…¨åŸå› ï¼Œæµè§ˆå™¨é™åˆ¶ä»è„šæœ¬å†…å‘èµ·çš„è·¨æº HTTP è¯·æ±‚ï¼ŒXMLHttpRequest å’Œ Fetch APIï¼Œåªèƒ½ä»åŠ è½½åº”ç”¨ç¨‹åºçš„ä¸€ä¸ªåŸŸè¯·æ±‚ HTTP èµ„æºï¼Œé™¤éä½¿ç”¨`CORSå¤´æ–‡ä»¶`ã€‚

**`æµè§ˆå™¨é™åˆ¶`**ï¼šä¸ä¸€å®šæ˜¯æµè§ˆå™¨é™åˆ¶äº†å‘èµ·è·¨ç«™è¯·æ±‚ï¼Œä¹Ÿå¯èƒ½æ˜¯è·¨ç«™è¯·æ±‚å¯ä»¥æ­£å¸¸å‘èµ·ï¼Œä½†è¿”å›ç»“æœè¢«æµè§ˆå™¨æ‹¦æˆªã€‚

## CORS æ¦‚è¿°

è·¨åŸŸèµ„æºå…±äº«æ ‡å‡†æ–°å¢äº†ä¸€ç»„ HTTP é¦–éƒ¨å­—æ®µï¼Œ**å…è®¸æœåŠ¡å™¨å£°æ˜å“ªäº›æºç«™é€šè¿‡æµè§ˆå™¨æœ‰æƒé™è®¿é—®å“ªäº›èµ„æº**ã€‚

å¦å¤–ï¼Œè§„èŒƒè¦æ±‚ï¼Œå¯¹é‚£äº›å¯èƒ½å¯¹æœåŠ¡å™¨æ•°æ®äº§ç”Ÿå‰¯ä½œç”¨çš„ HTTP è¯·æ±‚æ–¹æ³•ï¼ˆç‰¹åˆ«æ˜¯ GET ä»¥å¤–çš„ HTTP è¯·æ±‚ï¼Œæˆ–è€…æ­é…æŸäº› MIME ç±»å‹çš„ POST è¯·æ±‚ï¼‰ï¼Œ**æµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ª`é¢„æ£€è¯·æ±‚`ï¼ˆpreflight requestï¼‰ï¼Œä»è€Œè·çŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸è¯¥è·¨åŸŸè¯·æ±‚ã€‚**

**æœåŠ¡å™¨ç¡®è®¤å…è®¸ä¹‹åï¼Œæ‰å‘èµ·å®é™…çš„HTTPè¯·æ±‚**ã€‚ åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆåŒ…æ‹¬ cookie å’Œ HTTP è®¤è¯ç›¸å…³æ•°æ®ï¼‰ã€‚

è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šå›¾ã€‚

![](https://user-images.githubusercontent.com/25027560/50205846-accac300-03a4-11e9-8654-2d646d237820.png)

### ç®€å•è¯·æ±‚

ä¸ä¼šè§¦å‘ CORS é¢„æ£€çš„è¯·æ±‚ç§°ä¸ºç®€å•è¯·æ±‚ï¼Œæ»¡è¶³ä»¥ä¸‹**æ‰€æœ‰æ¡ä»¶**çš„æ‰ä¼šè¢«è§†ä¸ºç®€å•è¯·æ±‚ï¼ŒåŸºæœ¬ä¸Šæ—¥å¸¸å¼€å‘åªä¼šå…³æ³¨å‰é¢ä¸¤ç‚¹ã€‚

- ä½¿ç”¨ `GET`ã€`POST`ã€`HEAD` å…¶ä¸­ä¸€ç§æ–¹æ³•
- åªä½¿ç”¨äº†å¦‚ä¸‹çš„å®‰å…¨é¦–éƒ¨å­—æ®µï¼Œä¸å¾—äººä¸ºè®¾ç½®å…¶ä»–é¦–éƒ¨å­—æ®µ
  - `Accept`
  - `Accept-Language`
  - `Content-Language`
  - `Content-Type` ä»…é™ä»¥ä¸‹ä¸‰ç§
    - `text/plain`
    - `multipart/form-data`
    - `application/x-www-form-urlencoded`
  - HTML å¤´éƒ¨ header filed å­—æ®µï¼š`DPR`ã€`Download`ã€`Save-Data`ã€`Viewport-Width`ã€`Width`
- è¯·æ±‚ä¸­çš„ä»»æ„ `XMLHttpRequestUpload` å¯¹è±¡å‡æ²¡æœ‰æ³¨å†Œä»»ä½•äº‹ä»¶ç›‘å¬å™¨ï¼›`XMLHttpRequestUpload`å¯¹è±¡å¯ä»¥ä½¿ç”¨ `XMLHttpRequest.upload` å±æ€§è®¿é—®
- è¯·æ±‚ä¸­æ²¡æœ‰ä½¿ç”¨ `ReadableStream` å¯¹è±¡

### é¢„æ£€è¯·æ±‚

éœ€é¢„æ£€çš„è¯·æ±‚è¦æ±‚å¿…é¡»ä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œä»¥è·çŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸è¯¥å®é™…è¯·æ±‚ã€‚`é¢„æ£€è¯·æ±‚` çš„ä½¿ç”¨ï¼Œå¯ä»¥é¿å…è·¨åŸŸè¯·æ±‚å¯¹æœåŠ¡å™¨çš„ç”¨æˆ·æ•°æ®äº§ç”Ÿæœªé¢„æœŸçš„å½±å“ã€‚

ä¸‹é¢çš„è¯·æ±‚ä¼šè§¦å‘é¢„æ£€è¯·æ±‚ï¼Œå…¶å®**éç®€å•è¯·æ±‚ä¹‹å¤–çš„éƒ½ä¼šè§¦å‘é¢„æ£€**

- ä½¿ç”¨ `PUT`ã€`DELETE`ã€`CONNECT`ã€`OPTIONS`ã€`TRACE`ã€`PATCH` æ–¹æ³•
- äººä¸ºè®¾ç½®äº†éè§„å®šå†…çš„å…¶ä»–é¦–éƒ¨å­—æ®µï¼Œå‚è€ƒä¸Šé¢ç®€å•è¯·æ±‚çš„å®‰å…¨å­—æ®µé›†åˆï¼Œè¿˜è¦ç‰¹åˆ«æ³¨æ„ `Content-Type` çš„ç±»å‹
- `XMLHttpRequestUpload` å¯¹è±¡æ³¨å†Œäº†ä»»ä½•äº‹ä»¶ç›‘å¬å™¨
- è¯·æ±‚ä¸­ä½¿ç”¨äº† `ReadableStream` å¯¹è±¡

### è¯·æ±‚é™„å¸¦èº«ä»½å‡­è¯ => cookie

å¦‚æœå‘èµ·è¯·æ±‚æ—¶è®¾ç½® `WithCredentials` æ ‡å¿—è®¾ç½®ä¸º `true`ï¼Œä»è€Œå‘æœåŠ¡å™¨å‘é€ `cookie`ï¼Œä½†æ˜¯å¦‚æœæœåŠ¡å™¨çš„å“åº”ä¸­æœªæºå¸¦ `Access-Control-Allow-Credentials: true`ï¼Œæµè§ˆå™¨å°†ä¸ä¼šæŠŠå“åº”å†…å®¹è¿”å›ç»™è¯·æ±‚çš„å‘é€è€…ã€‚

å¯¹äºé™„å¸¦èº«ä»½å‡­è¯çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨ä¸å¾—è®¾ç½® `Access-Control-Allow-Origin` çš„å€¼ä¸º`*`ï¼Œå¿…é¡»æ˜¯æŸä¸ªå…·ä½“çš„åŸŸåã€‚

æ³¨æ„ï¼Œç®€å• GET è¯·æ±‚ä¸ä¼šè¢«é¢„æ£€ï¼›å¦‚æœæ­¤ç±»å¸¦æœ‰èº«ä»½å‡­è¯è¯·æ±‚çš„å“åº”ä¸­ä¸åŒ…å«è¯¥å­—æ®µï¼Œè¿™ä¸ªå“åº”å°†è¢«å¿½ç•¥æ‰ï¼Œå¹¶ä¸”æµè§ˆå™¨ä¹Ÿä¸ä¼šå°†ç›¸åº”å†…å®¹è¿”å›ç»™ç½‘é¡µã€‚

## å®Œæ•´è¯·æ±‚æµç¨‹

![](https://user-images.githubusercontent.com/25027560/50205881-c409b080-03a4-11e9-8a57-a2a6d0e1d879.png)

## CORS

### [Access-Control-Allow-Credentials](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials)

`Access-Control-Allow-Credentials` å“åº”å¤´ç”¨äºåœ¨è¯·æ±‚è¦æ±‚åŒ…å« credentials æ—¶ï¼Œå‘ŠçŸ¥æµè§ˆå™¨æ˜¯å¦å¯ä»¥å°†å¯¹è¯·æ±‚çš„å“åº”æš´éœ²ç»™å‰ç«¯ JS ä»£ç ã€‚

å½“è¯·æ±‚çš„ credentials æ¨¡å¼ä¸º include æ—¶ï¼Œæµè§ˆå™¨ä»…åœ¨å“åº”æ ‡å¤´ `Access-Control-Allow-Credentials` çš„å€¼ä¸º true çš„æƒ…å†µä¸‹å°†å“åº”æš´éœ²ç»™å‰ç«¯çš„ JS ä»£ç ã€‚

Credentials å¯ä»¥æ˜¯ cookiesã€authorization headers æˆ– TLS client certificatesã€‚

å½“ä½œä¸ºé¢„æ£€è¯·æ±‚çš„å“åº”çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œè¿™èƒ½è¡¨ç¤ºæ˜¯å¦çœŸæ­£çš„è¯·æ±‚å¯ä»¥ä½¿ç”¨ credentialsã€‚**æ³¨æ„ç®€å•çš„ GET è¯·æ±‚æ²¡æœ‰é¢„æ£€ï¼Œæ‰€ä»¥è‹¥ä¸€ä¸ªå¯¹èµ„æºçš„è¯·æ±‚ä»£ç† credentialsï¼Œå¦‚æœè¿™ä¸ªå“åº”å¤´æ²¡æœ‰éšèµ„æºè¿”å›ï¼Œå“åº”å°±ä¼šè¢«æµè§ˆå™¨å¿½è§†ï¼Œä¸ä¼šè¿”å›åˆ° web å†…å®¹ã€‚**

`Access-Control-Allow-Credentials` æ ‡å¤´éœ€è¦ä¸ `XMLHttpRequest.withCredentials` æˆ– Fetch API çš„ `Request()` æ„é€ å‡½æ•°ä¸­çš„ `credentials` é€‰é¡¹ç»“åˆä½¿ç”¨ã€‚Credentials å¿…é¡»åœ¨å‰åç«¯éƒ½è¢«é…ç½®ï¼ˆå³ `Access-Control-Allow-Credentials` header å’Œ XHR æˆ– Fetch requeset ä¸­éƒ½è¦é…ç½®ï¼‰æ‰èƒ½ä½¿å¸¦ credentials çš„ CORS è¯·æ±‚æˆåŠŸã€‚

#### tips

1. [ğŸ”—](https://maomao.ink/index.php/IT/1587.html) å¦‚æœæœåŠ¡å™¨ç«¯å¼€å¯äº† Access-Control-Allow-Credentials ä¸º trueï¼Œå‡è®¾æœåŠ¡å™¨ç«¯è®¾ç½®äº† Access-Control-Allow-Origin ä¸º *ï¼Œæ„å‘³ç€å°† cookie å¼€æ”¾ç»™äº†æ‰€æœ‰ç½‘ç«™ã€‚å¦‚æœæœåŠ¡ç«¯è®¾ç½®äº† `"Access-Control-Allow-Origin": "*"`ï¼Œå®¢æˆ·ç«¯è¯·æ±‚æ—¶æ— éœ€å†è®¾ç½® `withCredentials: true`ã€‚

### [script æ ‡ç­¾çš„ crossorigin å±æ€§](https://juejin.cn/post/6969825311361859598)

#### script æ ‡ç­¾è¯·æ±‚èµ„æº

1. script æ ‡ç­¾è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼Œrequest æ˜¯æ²¡æœ‰ origin å¤´çš„ã€‚
2. script æ ‡ç­¾è¯·æ±‚è·¨åŸŸèµ„æºçš„æ—¶å€™ï¼Œå†…éƒ¨è¿è¡Œå¦‚æœæŠ¥é”™çš„è¯ï¼Œ`window.onerror` æ•è·çš„æ—¶å€™ï¼Œå†…éƒ¨çš„ `error.message` åªèƒ½çœ‹åˆ° `Script error`ï¼Œçœ‹ä¸åˆ°å®Œæ•´çš„é”™è¯¯å†…å®¹ã€‚

#### script æ ‡ç­¾ crossorigin å±æ€§

1. è®¾ç½® `crossorigin` å±æ€§åï¼Œ`script` æ ‡ç­¾å»è¯·æ±‚èµ„æºçš„æ—¶å€™ï¼Œrequest ä¼šå¸¦ä¸Š origin å¤´ï¼Œç„¶åä¼šè¦æ±‚æœåŠ¡å™¨è¿›è¡Œ cors æ ¡éªŒï¼Œè·¨åŸŸçš„æ—¶å€™å¦‚æœ response header æ²¡æœ‰ `Access-Control-Allow-Origin` æ˜¯ä¸ä¼šæ‹¿åˆ°èµ„æºçš„ã€‚cors éªŒè¯é€šè¿‡åï¼Œæ‹¿åˆ°çš„ script è¿è¡Œå†…éƒ¨æŠ¥é”™çš„è¯ï¼Œ`window.onerror` æ•è·çš„æ—¶å€™ï¼Œå†…éƒ¨çš„ `error.message` å¯ä»¥çœ‹åˆ°å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ã€‚
2. `crossorigin` çš„å±æ€§å€¼åˆ†ä¸º `anonymous` å’Œ `use-credentials`ã€‚å¦‚æœè®¾ç½®äº† `crossorigin` å±æ€§ï¼Œä½†æ˜¯å±æ€§å€¼ä¸æ­£ç¡®çš„è¯ï¼Œé»˜è®¤æ˜¯ `anonymous`ã€‚
3. `anonymous` ä»£è¡¨åŒåŸŸä¼šå¸¦ä¸Š cookieï¼Œè·¨åŸŸåˆ™ä¸å¸¦ä¸Š cookieï¼Œç›¸å½“äº fetch è¯·æ±‚çš„ `credentials: 'same-origin'`ã€‚
4. `use-credentials` è·¨åŸŸä¹Ÿä¼šå¸¦ä¸Š cookieï¼Œç›¸å½“äº fetch è¯·æ±‚çš„ `credentials: 'include'`ï¼Œè¿™ç§æƒ…å†µä¸‹è·¨åŸŸçš„ response header éœ€è¦è®¾ç½® `'Access-Control-Allow-Credentials' = true`ï¼Œå¦åˆ™ cors å¤±è´¥ã€‚

#### æ€»ç»“

1. è®¾ç½®äº† `crossorigin` å±æ€§å°±ç›¸å½“äºå¼€å¯äº† cors æ ¡éªŒã€‚
2. å¼€å¯ cors æ ¡éªŒä¹‹åï¼Œè·¨åŸŸçš„ script èµ„æºåœ¨è¿è¡Œå‡ºé”™çš„æ—¶å€™ï¼Œ`window.onerror` å¯ä»¥æ•è·åˆ°å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ã€‚
3. `crossorigin=use-credentials` å¯ä»¥è·¨åŸŸå¸¦ä¸Š cookieã€‚
